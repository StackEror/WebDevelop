@page "/list-page"

@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using WebDevelopment.Client.Extensions
@using WebDevelopment.Shared.DTO
@using WebDevelopment.Shared.Enums
@using WebDevelopment.Shared.Interfaces
@using WebDevelopment.Shared.Modal.ModalSize

@inject ICountryService CountryService
@inject NavigationManager NavigationManager


<style>
    /* Dezactivare sageti de la InputNumner */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .input-label {
        margin-top:15px;
        display:inline-block
    }

    /* Scoatere sageata la input-select*/
    .no-arrow-select {
        background-image: none; 
    }
    /* Dezactivare border, outline verde la input valid*/
    .valid.modified:not([type=checkbox]) {
        outline: none;
    }
</style>
@if (IsLoading)
{
    <Loading />
}
else
{
    <button type="button" class="btn btn-primary m-3" @onclick="() => NavToAddOrUpdate()">Add Or Update Country</button>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Id </th>
                <th>Name</th>
                <th>Continent</th>
                <th>Rank</th>
                <th>CountrySize</th>
                <th>CreatedAt</th>
                <th>UpdatedAt</th>
                <th>PeopleCount</th>
                <th>IsIsland</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Countries)
            {
                <tr>
                    <th id="textToCopy">@item.Id</th>@*<button onclick="copyText('@item.Id')">Copy</button>*@
                    <th>@item.Name</th>
                    <th>@(EnumExtensions.GetDisplayName(item.Continent))</th>
                    <th>@item.Rank.GetDisplayName()</th>
                    <th>@GetEnumName(item.CountrySize)</th>
                    <th>@item.CreatedAt</th>
                    <th>@item.UpdatedAt</th>
                    <th>@item.PeopleCount</th>
                    <th>@item.IsIsland</th>
                    <th>
                        <div style="display:flex;">
                            <button type="button" class="btn btn-primary m-3" @onclick="() => NavToAddOrUpdate(item.Id.ToString())">Update</button>
                            <button type="button" class="btn btn-primary m-3" @onclick="() => ShowDeleteModal(item.Id)">Delete</button>
                        </div>
                    </th>
                </tr>
            }
        </tbody>
    </table>

    <button class="btn btn-primary" @onclick="ShowAddModal">Add country</button>
}


@if (_showAddModal)
{

    <BaseModal Title="Add new country" Size="@ModalSize.Medium" OnCancel="HideAddModal" OnConfirm="AddCountry">
        @*async () => await Add(Country)*@

        <EditForm EditContext="EditContext" FormName="AddCountry">
            <DataAnnotationsValidator></DataAnnotationsValidator>
            
            
            <label class="input-label">PeopleCount</label>
            <InputNumber class="form-control" @bind-Value="@Country.PeopleCount"></InputNumber>


            <label class="input-label">Type</label>
            <InputText class="form-control" @bind-Value="@Country.Type"></InputText>


            <label class="input-label">Name</label>
            <InputText class="form-control" @bind-Value="@Country.Name"></InputText>
            <ValidationMessage For="() => Country.Name"></ValidationMessage>
            
            
            <label class="input-label">Continent</label>
            <InputSelect class="form-select no-arrow-select" TValue="ContinentEnum?" @bind-Value="@Country.Continent">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(ContinentEnum)).Cast<ContinentEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.Continent"></ValidationMessage>
            
            
            <label class="input-label">CountrySize</label>
            <InputSelect class="form-select" TValue="CountrySizeEnum?" @bind-Value="@Country.CountrySize">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(CountrySizeEnum)).Cast<CountrySizeEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.CountrySize"></ValidationMessage>


            <label class="input-label">Rank</label>
            <InputSelect class="form-select" TValue="RankEnum?" @bind-Value="@Country.Rank">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(RankEnum)).Cast<RankEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.Rank"></ValidationMessage>


            <label class="input-label">IsIsland</label>
            <InputCheckbox @bind-Value="@Country.IsIsland"></InputCheckbox>
            @* <div>
                <button type="submit" class="btn btn-primary">Add country</button>
            </div> *@
        </EditForm>
    </BaseModal>

}

@* <script>
    function copyText(text) {
        navigator.clipboard.writeText(text);
    }
</script> *@

@if (_showDeleteModal)
{
    <BaseModal Title="Confirm" ShowLoading="false" OnCancel="HideDeleteModal" OnConfirm="Delete">
        Are you sure you want to delete this country
    </BaseModal>
}
@code {
    public CountryDto Country { get; set; } = new();
    public List<CountryDto> Countries { get; set; } = [];
    public string IdToUse { get; set; } = string.Empty;
    public bool IsLoading { get; set; } = true;
    public bool _showAddModal { get; set; } = false;
    public bool _showDeleteModal { get; set; } = false;
    private EditContext EditContext { get; set; }
    private Guid IdToDelete { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await GetList();
        EditContext = new EditContext(Country);
        IsLoading = false;
        StateHasChanged();
    }

    public async Task GetList()
    {
        IsLoading = true;
        var result = await CountryService.GetList();
        Countries = result.Data;
        IsLoading = false;
    }

    public void NavToAddOrUpdate(string Id = default!)
    {
        NavigationManager.NavigateTo($"add-or-update-country/{Id}");
    }

    public async Task Delete()
    {
        if (IdToDelete != Guid.Empty)
        {
            await CountryService.Delete(IdToDelete);
            HideDeleteModal();
        }
        await GetList();
        StateHasChanged();
    }

    private async Task AddCountry()
    {
        var isValid = EditContext.Validate();
        if (isValid)
        {
            await Add(Country);
            await GetList();
        }
    }

    public async Task Add(CountryDto model)
    {
        await CountryService.Add(model);
        Country = new();
        HideAddModal();
        StateHasChanged();
    }

    private void ShowAddModal() => _showAddModal = true;
    private void HideAddModal() => _showAddModal = false;
    private void ShowDeleteModal(Guid Id)
    {
        IdToDelete = Id;
        _showDeleteModal = true;
    }
    private void HideDeleteModal() => _showDeleteModal = false;

    private string GetEnumName(Enum? value) => EnumExtensions.GetDisplayName(value);
}
