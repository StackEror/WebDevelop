@page "/list-page"

@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using WebDevelopment.Shared.DTO
@using WebDevelopment.Shared.Enums
@using WebDevelopment.Shared.Interfaces
@using WebDevelopment.Shared.Modal.ModalSize

@inject ICountryService CountryService
@inject NavigationManager NavigationManager

@if (IsLoading)
{
    <Loading />
}
else
{
    <button type="button" class="btn btn-primary m-3" @onclick="() => NavToAddOrUpdate()">Add Or Update Country</button>


    <table class="table table-bordered table-striped">
        @*class="table table-bordered table-striped">*@
        <thead>
            <tr>
                <th>Id </th>
                <th>Name</th>
                <th>Continent</th>
                <th>Rank</th>
                <th>CountrySize</th>
                <th>CreatedAt</th>
                <th>UpdatedAt</th>
                <th>PeopleCount</th>
                <th>IsIsland</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Countries)
            {
                <tr>
                    <th id="textToCopy">@item.Id</th>@*<button onclick="copyText('@item.Id')">Copy</button>*@
                    <th>@item.Name</th>
                    <th>@GetDisplayName(item.Continent)</th>
                    <th>@GetDisplayName(item.Rank)</th>
                    <th>@GetDisplayName(item.CountrySize)</th>
                    <th>@item.CreatedAt</th>
                    <th>@item.UpdatedAt</th>
                    <th>@item.PeopleCount</th>
                    <th>@item.IsIsland</th>
                    <th>
                        <div style="display:flex;">
                            <button type="button" class="btn btn-primary m-3" @onclick="() => NavToAddOrUpdate(item.Id.ToString())">Update</button>
                            <button type="button" class="btn btn-primary m-3" @onclick="() => ShowDeleteModal(item.Id)">Delete</button>
                        </div>
                    </th>
                </tr>
            }
        </tbody>
    </table>
}



<button class="btn btn-primary" @onclick="ShowAddModal">Add country</button>


@if (_ShowAddModal)
{

    <BaseModal Title="Add new country" Size="@ModalSize.Medium" OnCancel="HideAddModal" OnConfirm="AddCountry">@*async () => await Add(Country)*@

        <EditForm EditContext="EditContext" FormName="AddCountry">
            <DataAnnotationsValidator></DataAnnotationsValidator>
            <p>PeopleCount</p>
            <InputNumber @bind-Value="@Country.PeopleCount"></InputNumber>

            <p style="margin-top:10px;">Type</p>
            <InputText @bind-Value="@Country.Type"></InputText>

            <p style="margin-top:10px;">Name</p>
            <InputText @bind-Value="@Country.Name"></InputText>
            <ValidationMessage For="() => Country.Name"></ValidationMessage>



            <p style="margin-top:10px;">Continent</p>
            <InputSelect TValue="ContinentEnum?" @bind-Value="@Country.Continent">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(ContinentEnum)).Cast<ContinentEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.Continent"></ValidationMessage>




            <p style="margin-top:10px;">CountrySize</p>
            <InputSelect TValue="CountrySizeEnum?" @bind-Value="@Country.CountrySize">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(CountrySizeEnum)).Cast<CountrySizeEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.CountrySize"></ValidationMessage>


            <p style="margin-top:10px;">Rank</p>
            <InputSelect TValue="RankEnum?" @bind-Value="@Country.Rank">
                <option value="">Select...</option>
                @foreach (var val in Enum.GetValues(typeof(RankEnum)).Cast<RankEnum>())
                {
                    <option value="@val">@val</option>
                }
            </InputSelect>
            <ValidationMessage For="() => Country.Rank"></ValidationMessage>



            <InputCheckbox @bind-Value="@Country.IsIsland"></InputCheckbox>
            @* <div>
                <button type="submit" class="btn btn-primary">Add country</button>
            </div> *@
        </EditForm>
    </BaseModal>

}

@* <script>
    function copyText(text) {
        navigator.clipboard.writeText(text);
    }
</script> *@

@if (_ShowDeleteModal)
{
    <BaseModal Title="Confirm" OnCancel="HideDeleteModal" OnConfirm="Delete">
        Are you sure you want to delete this country
    </BaseModal>
}
@code {
    public CountryDto Country { get; set; } = new();
    public List<CountryDto> Countries { get; set; } = [];
    public string IdToUse { get; set; } = string.Empty;
    public bool IsLoading { get; set; } = true;
    public bool _ShowAddModal { get; set; } = false;
    public bool _ShowDeleteModal { get; set; } = false;
    private EditContext EditContext { get; set; }
    private Guid IdToDelete { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await GetList();
        await Task.Delay(100);
        EditContext = new EditContext(Country);
        IsLoading = false;
        StateHasChanged();
    }

    public async Task GetList()
    {
        IsLoading = true;
        var result = await CountryService.GetList();
        Countries = result.Data;
        IsLoading = false;
    }

    public void NavToAddOrUpdate(string Id = default!)
    {
        NavigationManager.NavigateTo($"add-or-update-country/{Id}");
    }

    public async Task Delete()
    {
        if (IdToDelete != Guid.Empty)
        {
            await CountryService.Delete(IdToDelete);
            HideDeleteModal();
        }
        await GetList();
        StateHasChanged();
    }

    private async Task AddCountry()
    {
        var isValid = EditContext.Validate();
        if (isValid)
        {
            await Add(Country);
            await GetList();
        }
    }

    public async Task Add(CountryDto model)
    {
        await CountryService.Add(model);
        Country = new();
        HideAddModal();
        StateHasChanged();
    }


    private void ShowAddModal() => _ShowAddModal = true;
    private void HideAddModal() => _ShowAddModal = false;
    private void ShowDeleteModal(Guid Id)
    {
        IdToDelete = Id;
        _ShowDeleteModal = true;
    }
    private void HideDeleteModal() => _ShowDeleteModal = false;

    public static string GetDisplayName(Enum enumValue)
    {
        var member = enumValue.GetType().GetMember(enumValue.ToString()).First();
        var display = member.GetCustomAttribute<DisplayAttribute>();

        return display?.GetName() ?? enumValue.ToString();
    }

}
