@page "/change-password"
@layout BlankLayout

@using WebDevelopment.Client.Interfaces
@using WebDevelopment.Client.Models.Authentication

@inject NavigationManager NavigationManager
@inject IUserService UserService


<AuthorizeView Context="AuthContext">
    <Authorized>

        <Card>
            <p class="h4 fw-semibold mb-2 text-center">Reset Password</p>
            <EditForm OnValidSubmit="HandleChangePassword" Model="@Model">
                <DataAnnotationsValidator></DataAnnotationsValidator>

                <label for="signin-password" class="form-label text-default d-block">New Password</label>

                <div class="auth-input-group">
                    <i class="fa fa-lock prefix-icon"></i>
                    <InputText type="@(showNewPassword ? "text" : "password")"
                               class="form-control"
                               placeholder="Password"
                               @bind-value="Model.NewPassword" />
                    <button type="button"
                            class="btn btn-outline-primary toggle-password"
                            @onclick="ToggleNewPasswordVisibility"
                            aria-label="@(showNewPassword ? "Hide password" : "Show password")">
                        <i class="@(showNewPassword ? "fa-solid fa-eye-slash" : "fa-solid fa-eye")"></i>
                    </button>
                </div>

                <ValidationMessage For="(() => Model.NewPassword)" class="text-danger fs-13" />
                <span class="text-danger fs-13">@NewPasswordErrorMessage</span>


                <label for="signin-password" class="form-label text-default d-block">Confirm new password</label>

                <div class="auth-input-group">
                    <i class="fa fa-lock prefix-icon"></i>
                    <InputText type="@(showConfirmPassword ? "text" : "password")"
                               class="form-control"
                               placeholder="Confirm new password"
                               @bind-Value="Model.ConfirmPassword" />
                    <button type="button"
                            class="btn btn-outline-primary toggle-password"
                            @onclick="ToggleConfirmPasswordVisibility"
                            aria-label="@(showConfirmPassword ? "Hide password" : "Show password")">
                        <i class="@(showConfirmPassword ? "fa-solid fa-eye-slash" : "fa-solid fa-eye")"></i>
                    </button>
                </div>


                <ValidationMessage For="(() => Model.ConfirmPassword)" />@*class="text-danger fs-13"*@
                <span class="text-danger fs-13">@ConfirmPasswordErrorMessage</span>

                <button type="submit" class="auth-btn">
                    Change
                </button>
            </EditForm>
        </Card>

    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>



@code {
    private ChangePasswordModel Model { get; set; } = new();

    private string ErrorMessage = string.Empty;

    private string OldPasswordErrorMessage = string.Empty;

    private string NewPasswordErrorMessage = string.Empty;

    private string ConfirmPasswordErrorMessage = string.Empty;

    private bool showNewPassword = false;

    private bool ShowErrorMessage = false;

    private bool IsLoading = true;


    private async Task HandleChangePassword()
    {
        if (Model != null && !string.IsNullOrEmpty(Model.NewPassword) && !string.IsNullOrEmpty(Model.ConfirmPassword) && Model.ConfirmPassword.Equals(Model.NewPassword))
        {
            IsLoading = true;

            StateHasChanged();

            var response = await UserService.ChangePassword(Model);

            if (response.IsSuccess)
            {
                var updateTokenResponse = await UserService.UpdateAccesToken();

                if (updateTokenResponse != null && updateTokenResponse.IsSuccess)
                {
                    NavigationManager.NavigateTo("/");
                }
            }
            else
            {
                ConfirmPasswordErrorMessage = response.Message;
                IsLoading = false;
                StateHasChanged();
            }
        }
    }


    private bool showConfirmPassword = false;

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private bool showOldPassword = false;

    private void ToggleOldPasswordVisibility()
    {
        showOldPassword = !showOldPassword;
    }

    private void ToggleNewPasswordVisibility()
    {
        showNewPassword = !showNewPassword;
    }

    private async Task RedirectToLogin()
    {
        NavigationManager.NavigateTo("login");
        await Task.CompletedTask;
    }
}


<style>
    .up-logo-container {
        display: none;
    }

    .default-card-style {
        width: 350px;
    }

    .auth-input-group {
        display: flex; /* Aliniază elementele pe orizontală */
        position: relative;
        width: 100%;
        margin-bottom: 1rem;
    }

        /* Iconița de lacăt (prefix) */
        .auth-input-group .prefix-icon {
            position: absolute;
            top: 50%;
            left: 14px;
            transform: translateY(-50%);
            color: #9aa0a6;
            z-index: 2; /* Asigură-te că stă deasupra inputului */
        }

        /* Stilul pentru InputText */
        .auth-input-group .form-control {
            flex-grow: 1; /* Ocupă tot spațiul disponibil */
            padding: 12px 14px 12px 42px;
            border-radius: 10px 0 0 10px; /* Rotunjit doar la stânga */
            border: 1px solid #d0d5dd;
            border-right: none; /* Elimină bordura dintre input și buton */
            outline: none;
        }

        /* Stilul pentru butonul de Eye */
        .auth-input-group .toggle-password {
            background: #fff;
            border: 1px solid #d0d5dd;
            border-left: 1px solid #eee; /* O linie foarte fină de separare sau deloc */
            border-radius: 0 10px 10px 0; /* Rotunjit doar la dreapta */
            padding: 0 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

            .auth-input-group .toggle-password i {
                color: #1563b1; /* Culoarea albastră din imaginea ta */
                position: static; /* Resetăm poziționarea absolută moștenită */
                transform: none;
            }

        /* Efect de Focus pentru întreg grupul */
        .auth-input-group:focus-within .form-control,
        .auth-input-group:focus-within .toggle-password {
            border-color: #1563b1;
            box-shadow: 0 0 0 3px rgba(21, 99, 177, 0.1);
        }

        .auth-input-group i {
            position: absolute;
            top: 50%;
            left: 14px;
            transform: translateY(-50%);
            color: #9aa0a6;
            font-size: 16px;
        }

        .auth-input-group input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            border-radius: 10px;
            border: 1px solid #d0d5dd;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            background-color: #fff;
        }

            .auth-input-group input::placeholder {
                color: #9aa0a6;
            }

            .auth-input-group input:focus {
                border-color: #1563b1;
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
            }

                .auth-input-group input:focus + i,
                .auth-input-group input:focus ~ i {
                    color: #1563b1;
                }

    .auth-btn {
        width: 100%;
        padding: 12px;
        background: #1563b1;
        border: none;
        border-radius: 10px;
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
    }

        .auth-btn:hover {
            background: #0f4c8a;
        }

    .auth-switch {
        text-align: center;
        margin-top: 1.25rem;
        font-size: 14px;
        color: #6b7280;
    }

        .auth-switch a {
            color: #1563b1;
            font-weight: 600;
            margin-left: 4px;
            text-decoration: none;
            cursor: pointer;
        }

            .auth-switch a:hover {
                text-decoration: underline;
            }

    .spinner-overlay {
        height: 100% !important;
    }
</style>